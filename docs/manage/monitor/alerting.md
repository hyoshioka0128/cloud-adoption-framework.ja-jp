---
title: クラウドの監視とアラート
description: Microsoft Azure で System Center Operations Manager や Azure Monitor をどのようなときに使用すべきかを、Azure 向けのクラウド導入フレームワークを使用して学習します。
author: MGoedtel
ms.author: brblanch
ms.date: 08/05/2020
ms.topic: conceptual
ms.service: cloud-adoption-framework
ms.subservice: operate
ms.custom: think-tank
ms.openlocfilehash: 668bc647cea1f1ae521e37b43a461ff54f0eab33
ms.sourcegitcommit: 51565dc4d3a1858bd62f708f2e4c082fbd4c6fe4
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/20/2021
ms.locfileid: "107746567"
---
<!-- cSpell:ignore multisignal -->

# <a name="cloud-monitoring-guide-alerting"></a>クラウド監視ガイド: アラート

何年もの間、IT 組織は、企業に展開された監視ツールから生成されるアラート疲れとの戦いに苦労してきました。 多くのシステムからはアラートが大量に生成され、意味がないと考えられるものも多いのですが、関連性があるにもかかわらず見過ごされたり、無視されたりするアラートもあります。 その結果、IT と開発者の業務においては苦労して、社内や社外の顧客に約束したサービスレベル品質を満たしてきました。 信頼性を確保するためには、インフラストラクチャとアプリケーションの状態を理解することが不可欠です。 サービスの低下や中断を最小限に抑える、インシデントの影響を軽減する、またはインシデント数を減らすには、原因をすばやく特定する必要があります。

## <a name="successful-alerting-strategy"></a>適切なアラート戦略

*知らないものが壊れても直すことはできません。*

重要なことについてアラートを発することが欠かせません。 適切なメトリックとログの収集と測定を行うことが、その土台となります。 また、格納、集計、視覚化、分析、および条件が満たされたときの自動応答の開始が可能な監視ツールが必要です。 サービスとアプリケーションの監視を改善できるのは、その構成を完全に理解している場合に限られます。 その構成を、監視プラットフォームによって適用される詳細な監視構成にマップします。 この構成には、アラートの対象とする意味がある、予測可能な障害状態 (障害の原因ではなく、現象) が含まれます。

ある症状がアラートの適切な候補であるかどうかを判断するには、以下の原則を考慮します。

- **重要ですか。** それは実際の問題の症状を示している問題ですか、それともアプリケーションの全体的正常性に影響している問題ですか。 たとえば、リソースでの CPU 使用率が高いかどうかは重要ですか。 または、そのリソースの SQL データベース インスタンスで実行されている特定の SQL クエリの CPU 使用率が長時間にわたって高いかどうかが重要ですか。 CPU 使用率の状態は実際の問題であるため、それに対してアラートを発行する必要があります。 しかし、チームに通知する必要はありません。そもそも何がその状態を引き起こしているかを知る助けにはならないためです。 SQL クエリ プロセスの使用率の問題に関する警告と通知は、関連性があり、かつ実用的です。
- **緊急ですか。** 問題が現実のもので、緊急の注意を必要としていますか。 もしそうであれば、担当チームにすぐに通知する必要があります。
- **顧客は影響を受けますか。** 問題の結果として、サービスまたはアプリケーションのユーザーは影響を受けますか。
- **他の依存システムは影響を受けますか。** 相互に関係がある依存関係に起因するアラートのうち、異なるチームに通知が行われ、全チームが同じ問題に取り組むことを避けるために対応付けが可能なものはありますか。

監視構成を最初に開発しようとしているときに、これらの疑問に答えます。 前提条件は、非運用環境でテストおよび検証してから運用環境に展開します。 監視構成は、既知の障害モード、シミュレートされた障害のテスト結果、およびチームのさまざまなメンバーの経験から得られます。

監視構成のリリース後は、何が機能していて何が機能していないかについて多くのことを突き止めることができます。 量が多いアラート、監視では認識されていないがエンド ユーザーが気付いた問題、およびこの評価の一環として実行することが最善であった措置について考察してください。 継続的監視を改善する進行中のプロセスの一環として、サービスの提供を改善するための実装に対する変更を特定します。 アラート ノイズやアラートが発生しない状況について評価するだけでなく、ワークロードの監視方法の有効性についても評価します。 アラートのポリシー、プロセス、および改善が進んでいるかどうかを判断するための全体的訓練に関する有効性が、その対象です。

System Center Operations Manager と Azure Monitor はどちらも、静的しきい値または動的しきい値に基づくアラートと、それらに基づいて設定されたアクションをサポートしています。 例として、メール、SMS、音声通話のアラートで簡単に通知を受け取れます。 これらのサービスはどちらも IT サービス管理 (ITSM) 統合もサポートしており、インシデント レコードの作成の自動化と、適切なサポート チーム、または Webhook を使用するその他のアラート管理システムへのエスカレートを行います。

可能なときには、いくつかのサービスのいずれかを使用して回復操作を自動化できます。 エラスティック ワークロードの場合は、System Center Orchestrator、Azure Automation、Azure Logic Apps、自動スケールが含まれます。 担当チームにアラートを通知することが最も一般的な操作ですが、是正措置を自動化することが適切な場合もあります。 この自動化は、インシデント管理プロセス全体の合理化に役立ちます。 これらの回復タスクを自動化すると、人的エラーのリスクも軽減できます。

## <a name="azure-monitor-alerting"></a>Azure Monitor のアラート

Azure Monitor のみを使用している場合は、速度、コスト、およびストレージ容量について検討する際に、次のガイドラインに従ってください。

使用している機能と構成に応じて、次の 6 つのリポジトリのいずれかに監視データを保存できます。

- **Azure Monitor メトリック データベース:** 主に Azure Monitor プラットフォームのメトリックに使用される時系列データベースですが、Application Insights メトリック データも反映されています。 このデータベースに入力される情報は、最も速いアラート時間です。

- **Application Insights リソース:** ほとんどの Application Insights テレメトリをログ形式で格納するデータベース。

- **Azure Monitor Log Analytics ワークスペース:** Azure ログデータのプライマリ ストア。 その他のツールで、データをルーティングし、Azure Monitor ログで分析することができます。 インジェストとインデックス作成のために、ログ アラート クエリの待機時間は長くなります。 この待機時間は通常 5 ～ 10 分ですが、状況によってはより長くなることがあります。

- **アクティビティ ログ:** すべてのアクティビティ ログとサービス正常性イベントに使用されます。 専用のアラートを使用できます。 サブスクリプション内のオブジェクトの外側から見て、それらのオブジェクトで発生するサブスクリプション レベルのイベントを保持します。 たとえば、ポリシーが設定されたり、リソースのアクセスや削除が行われたりしたときです。

- **Azure Storage:** Azure Diagnostics やその他の監視ツールでサポートされている汎用ストレージ。 これは、監視テレメトリの長期保持に適した低コストの選択肢です。 このサービスに保存されているデータからのアラートはサポートされていません。

- **Event Hubs:** 一般に、オンプレミスまたは他のパートナーの監視または ITSM ツールにデータをストリーミングするために使用されます。

Azure Monitor には 4 種類のアラートがあり、それぞれ、データが保存されているリポジトリとある程度関連性があります。

- [メトリック アラート](/azure/azure-monitor/alerts/alerts-metric):Azure Monitor のメトリック データに関するアラート。 アラートは、監視対象の値がユーザー定義のしきい値を超えたとき、そしてその後、値が "通常" 状態に戻るときに発生します。

- [ログ クエリ アラート](/azure/azure-monitor/alerts/alerts-log-query):Application Insights または Azure Monitor ログのログ データに関するアラートに使用できます。 クロスワークスペース クエリに基づいて警告することもできます。

- [アクティビティ ログ アラート](/azure/azure-monitor/alerts/alerts-activity-log):Azure Service Health データを除く、アクティビティ ログ内の項目に関するアラート。

- [Azure Service Health アラート](/azure/service-health/alerts-activity-log-service-notifications-portal):停止や予定されている計画メンテナンスなど、アクティビティ ログからの Azure Service Health の問題に対してのみ使用される特別な種類のアラートです。 この種類のアラートは、Azure Monitor するコンパニオン サービスである [Azure Service Health](/azure/service-health/service-health-overview) を使用して構成されることに注意してください。

### <a name="enable-alerting-through-partner-tools"></a>パートナー ツールによるアラートを有効にする

外部のアラート ソリューションを使用する予定の場合は、できるだけ多くのアラートを Azure Event Hubs 経由でルーティングします。これは、Azure Monitor から出る最速のパスです。 Event Hubs へのインジェストの料金を支払う必要があります。 コストが問題で、速度はそうでない場合は、より低コストの代替策として Azure Storage を利用できます。 監視ツールや ITSM ツールが Azure Storage を読み取ってデータを抽出できるようにするだけです。

Azure Monitor には、他の監視プラットフォームや、ServiceNow などの ITSM ソフトウェアとの統合のサポートが含まれています。 Azure のアラートを使用しても、インシデント管理や DevOps プロセスの要件に従って、Azure の外部でアクションをトリガーできます。 Azure Monitor でアラートを出して応答を自動化する場合は、実際のシナリオと要件に基づいて Azure Functions、Azure Logic Apps、または Azure Automation を使用することで、自動化されたアクションを開始できます。

### <a name="specialized-azure-monitoring-offerings"></a>特殊な Azure 監視オファリング

[管理ソリューション](/azure/azure-monitor/monitor-reference)は一般に、データを Azure Monitor ログに格納します。 2 つの例外は、Azure Monitor for VMs と Azure Monitor for Containers です。 次の表では、特定のデータ型とその格納場所に基づくアラートのエクスペリエンスについて説明します。

| 解決策 | データ型 | アラート動作 |
|---| ---| --- |
| コンテナーに対する Azure Monitor | ノードとポッドの計算された平均パフォーマンス データは、メトリック データベースに書き込まれます。 | 一定期間にわたって集計される、使用量の測定済みパフォーマンスの変動に基づいてアラートを受け取る必要がある場合は、メトリック アラートを作成します。 |
| | ノード、コントローラー、コンテナー、およびポッドからのパーセンタイルを使用する計算後のパフォーマンス データは、ワークスペースに書き込まれます。 コンテナー ログとインベントリ情報もワークスペースに書き込まれます。 | クラスターおよびコンテナーの測定済み使用量の変動に基づいてアラートを受け取る必要がある場合は、ログ クエリ アラートを作成します。 ログ クエリ アラートは、ポッドフェーズ数と状態ノード数に基づいて構成することもできます。 |
| VM に対する Azure Monitor | 正常性基準は、メトリック データベースに格納されているメトリックです。 | 正常性状態が正常から異常に変化すると、アラートが生成されます。 このアラートでは、SMS またはメール通知を送信するように構成されたアクション グループだけがサポートされています。 |
| | マップおよびゲスト オペレーティング システムのパフォーマンス ログ データは Log Analytics ワークスペースに書き込まれます。 | ログ クエリ アラートを作成します。 |

### <a name="fastest-speed-driven-by-cost"></a>コストに基づく最高速度

サービスに影響を与える問題のアラートと迅速な解決を促進する最も重要な決定の 1 つは待機時間です。 5 分未満でのほぼリアルタイムのアラートが必要な場合は、テレメトリに関するアラートが既定の保存場所にあるか、またはそこで取得できるかを最初に評価します。 一般的に、使用中のツールは既にその場所にデータを送信しているため、この戦略は最もコストが低い選択肢でもあります。

とは言え、この原則にはいくつかの重要な注意事項があります。

**ゲスト OS テレメトリ** には、システムに取得するパスが複数あります。

- このデータに対してアラートを発する最速の方法は、それをカスタム メトリックとしてインポートすることです。 これは、Azure Diagnostics 拡張機能を使用し、次にメトリック アラートを使用することで行います。 ただし、カスタム メトリックは現在プレビュー段階であり、[他の選択肢よりもコストが高くなります](https://azure.microsoft.com/pricing/details/monitor/)。

- 多少のインジェスト待機時間を伴うものの、最も安価なのは、Log Analytics ワークスペースに送信することです。 VM 上で Log Analytics エージェントを実行することは、すべてのゲスト オペレーティング システムのメトリックとログ データをワークスペースに取り込む方法として最適です。

- 同じ VM 上で Azure Diagnostics 拡張機能と Log Analytics エージェントの両方を実行することで、Azure Monitor でメトリックおよびログとしてストレージに送信できます。 その後はより迅速にアラートを送信できますが、ゲスト オペレーティング システムのデータは、他のテレメトリと組み合わせると、より複雑なクエリの一部としても使用することもできます。

**オンプレミスのデータのインポート:** Azure とオンプレミスで実行されている複数のコンピューターにわたってクエリと監視を行おうとしている場合は、Log Analytics エージェントを使用してゲスト オペレーティング システムのデータを収集できます。 その後、Azure Monitor で "[ログからメトリックへ](/azure/azure-monitor/alerts/alerts-metric-logs)" と呼ばれる機能を使用して、メトリックとして収集して保存できます。 この方法によって、Azure Monitor ログへのインジェスト プロセスの一部がバイパスされるため、データがすぐに利用可能になります。

### <a name="minimize-alerts"></a>アラートを最小限に抑える

Azure Monitor for VMs などのソリューションを使用していて、パフォーマンスの使用率を監視する既定の正常性基準を受け入れられる場合は、同じパフォーマンス カウンターに基づく重複するメトリックを作成したり、クエリ アラートをログに記録したりしないでください。

Azure Monitor for VMs を使用していない場合は、以下の機能について検討することで、アラートの作成と通知の管理の仕事を簡単にします。

> [!NOTE]
> これらの機能は、メトリック アラート、つまり Azure Monitor のメトリック データベースに送信されるデータに基づくアラートにのみ適用されます。 他の種類のアラートには機能は適用されません。 前述のように、メトリック アラートの主な目的は速度です。 5 分未満でアラートを受け取ることが主な関心事でなければ、代わりにログ クエリ アラートを使用できます。

- [動的しきい値](/azure/azure-monitor/alerts/alerts-dynamic-thresholds):動的しきい値では、一定期間にわたってリソースのアクティビティを調べ、"通常動作" と見なすしきい値の上限と下限を作成します。 監視対象のメトリックがこれらのしきい値の範囲外になると、アラートを受け取ります。

- [マルチシグナル アラート](https://azure.microsoft.com/blog/monitor-at-scale-in-azure-monitor-with-multi-resource-metric-alerts/):2 つの異なるリソースの種類からの 2 つの異なる入力の組み合わせを使用するメトリック アラートを作成できます。 たとえば、VM の CPU 使用率が 90 パーセントを超え、その VM をフィードしている特定の Azure Service Bus キュー内のメッセージ数が一定量を超えたときにアラートを生成する場合は、ログ クエリを作成せずにそれを実行できます。 この機能は、2 つのシグナルに対してのみ機能します。 より複雑なクエリがある場合は、メトリック データを Log Analytics ワークスペースにフィードして、ログ クエリを使用します。

- [マルチソース アラート](https://azure.microsoft.com/blog/monitor-at-scale-in-azure-monitor-with-multi-resource-metric-alerts/):Azure Monitor では、すべての VM リソースに適用される単一のメトリック アラート ルールを使用できます。 VM ごとに個別のアラートを作成する必要がないため、この機能によって時間を節約できます。 この種類のアラートのコストは同じです。 50 台の VM の CPU 使用率を監視するために 50 のアラートを作成する場合でも、50 台すべての VM の CPU 使用率を監視する 1 つのアラートを作成する場合でも、かかるコストは同じです。 動的しきい値と組み合わせてこれらの種類のアラートを使用することもできます。

これらの機能を併用すると、アラート通知と基になるアラートの管理を最小限に抑えることで時間を節約できます。

### <a name="limits-on-alerts"></a>アラートに関する限度

[作成できるアラート数の限度](/azure/azure-resource-manager/management/azure-subscription-service-limits#azure-monitor-limits)に注意してください。 一部の限度 (すべてではありません) は、サポートに連絡して高めることができます。

### <a name="best-query-experience"></a>最適なクエリ エクスペリエンス

すべてのデータにわたる傾向を探そうとしている場合は、データが Application Insights に既にある場合を除き、すべてのデータを Azure Monitor ログにインポートするのが合理的です。 両方のワークスペースにまたがるクエリを作成できるので、それらの間でデータを移動する必要はありません。 アクティビティ ログと Azure Service Health データを Log Analytics ワークスペースにインポートすることもできます。 このインジェストとストレージに対して料金が発生しますが、分析とクエリのためにすべてのデータが 1 か所で取得されます。 このアプローチにより、複雑なクエリ条件と、それらに対するアラートを生成できるようにもなります。
