---
title: SAP 移行についてのエンタープライズ規模の事業継続とディザスター リカバリー
description: Azure 用の Microsoft クラウド導入フレームワークにおける SAP 移行についてのエンタープライズ規模の事業継続とディザスター リカバリーについて説明します。
author: JeffreyMitchell
ms.author: brblanch
ms.date: 3/12/2021
ms.topic: conceptual
ms.service: cloud-adoption-framework
ms.subservice: ready
ms.custom: think-tank, e2e-sap
ms.openlocfilehash: fca07481f369daf5585193dd6741db1f7abb3586
ms.sourcegitcommit: 5716a8165934bd69d02d9d3641785039196aee3a
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/29/2021
ms.locfileid: "105734486"
---
<!-- docutune:casing "Azure Fence Agent" -->
<!-- docutune:ignore DB -->

# <a name="enterprise-scale-business-continuity-and-disaster-recovery-for-an-sap-migration"></a>SAP 移行についてのエンタープライズ規模の事業継続とディザスター リカバリー

## <a name="scenario-and-scope"></a>シナリオとスコープ

組織またはエンタープライズは、アプリケーションのワークロードが固有の要件を満たすために使用できる、プラットフォーム レベルの機能を設計する必要があります。 組織の最も重要なビジネスプロセスを実行する SAP アプリケーションには、次の要件があります。

- サービス/ビジネスプロセスの可用性

- 障害または障害発生時の目標復旧時間 (RTO)、たとえば、障害シナリオが SAP システムのコンポーネントに限定されている場合、またはデータセンターまたは Azure リージョンに影響を与える広範囲にわたる障害が発生した場合などです。

- SAP システムのコンポーネントに限定される障害シナリオ、またはデータセンターまたは Azure リージョンに影響を与える広範囲にわたる障害の目標復旧時間 (RTO)
- 運用とライフサイクル管理タスクには、障害のシナリオに対応するテクノロジが必要になる場合があります。 これらの管理タスクには、ゲスト オペレーティング システムとデータベース管理システムの修正プログラムの適用、SAP システムの複製、更新などがあります。

アーキテクチャは、オンプレミスのビジネス継続性とディザスター リカバリー (BCDR) のシナリオに対応するための多くの原則とタスクで、Azure でも適用されます。 主な違いは、Azure は、ホストの障害を補うために組織よりも多くのハードウェア容量を持つ可能性があるという点です。 最大規模の Azure VM であっても、別のサーバーで再起動することによって、復旧することができます。 これ以外にも、オンプレミスと同じ条件が適用されます。 オンプレミスまたはベアメタル ハードウェアで自動フェールオーバー クラスター構成を使用してデプロイしたシステムも、この方法で Azure にデプロイする必要があります。

この記事では、エンタープライズ規模の SAP シナリオでの BCDR の次の側面について説明します。

- Azure リージョン内の高可用性 (HA)
- バックアップやリストアに関する考慮事項
- DR: リージョン間およびリージョンにおけるディザスター リカバリーの意思決定条件

### <a name="high-availability-ha-within-an-azure-region"></a>Azure リージョン内の高可用性 (HA)

**HA の設計に関する考慮事項:**

HA では、次のように、SAP ソフトウェアの単一障害点に対して可用性を提供することに重点を置いています。

- データベース管理システム
- ABAP SAP ASCS/SCS (たとえば、SAP NetWeaver と S/4HANA アーキテクチャを使用) のような、アプリケーションの単一障害点
- その他のツール (SAP Web Dispatcher など)

その他のシナリオでは、可用性をインフラストラクチャまたはソフトウェアの障害に限定することはできません。 VM、DBMS、または SAP ソフトウェアの OS に修正プログラムを適用するなど、必要なすべてのライフサイクル管理タスクを含める必要があります。 計画されたダウンタイムとライフサイクル管理タスクの間に発生する障害を最小限に抑えるために、計画外のサービス中断から保護する一般的なツールを使用できます。

SAP および SAP データベースでは、自動フェールオーバー クラスターがサポートされます。 Windows Server フェールオーバー クラスタリング機能は、Windows でこれを実現します。一方、Linux Pacemaker や、SIOS 保護スイートや Veritas InfoScale などのサードパーティ製ツールは Linux 用です。 Azure では、独自のデータセンターに HA 構成のサブセットのみをデプロイできます。

Azure でサポートされている SAP 機能の詳細については、[AZURE VM でサポートされている SAP ワークロードのシナリオ](/azure/virtual-machines/workloads/sap/sap-planning-supported-configurations)および[SAP HANA の大規模インスタンスでサポートされているシナリオ](/azure/virtual-machines/workloads/sap/hana-supported-scenario)に関するページを参照してください。

DBMS 層の場合、一般的なアーキテクチャ パターンでは、プライマリ VM とセカンダリ VM が使用している異なるストレージ スタックを使用して、データベースを同時にレプリケートします。 Azure では、プライマリ VM とセカンダリ VM が DBMS データ用にストレージを共有するアーキテクチャや、トランザクション/やり直しログをサポートしないアーキテクチャはサポートしていません。 基本原則は、ネットワーク ファイル システム (NFS) 共有に基づいていても、2 つの独立した記憶域スタックが必要であることです。これが、オンプレミスで可能なものと比較した場合の主な制限になります。

Azure では、NFS またはサーバー メッセージ ブロック共有のいずれかがサポートされているため、他のオプションが提示されます。 [Azure 共有ディスク](/azure/virtual-machines/disks-shared) は、WINDOWS で ASCS/SCS コンポーネントと特定の HA シナリオに使用できます。 SAP アプリケーション レイヤー コンポーネントと DBMS 層を組み合わせた HA アーキテクチャは Azure でサポートされていないため、SAP アプリケーション レイヤー コンポーネントと DBMS レイヤーに対してフェールオーバー クラスターを個別に設定する必要があります。

SAP アプリケーション レイヤー コンポーネントと DBMS レイヤーのフェールオーバー クラスターのほとんどには、フェールオーバー クラスターの仮想 IP アドレスが必要です。 一般的な例外の 1 つとして、Oracle Data Guard には仮想 IP アドレスを必要としない機能があります。 それ以外の場合は、 [Azure Load Balancer](/azure/load-balancer/load-balancer-overview)が仮想 IP アドレスを処理する必要があります。 設計上の原則として、クラスター構成ごとに 1 つのロード バランサーを使用します。ロードバランサーの標準バージョンをお勧めします。 詳細は、「[SAP の HA シナリオにおける Azure Standard Load Balancer を使用した 仮想マシンのパブリック エンドポイント接続](/azure/virtual-machines/workloads/sap/high-availability-guide-standard-load-balancer-outbound-connections)」を参照してください。

詳細と可能性については、「[SAP NetWeaver の HA アーキテクチャとシナリオ](/azure/virtual-machines/workloads/sap/sap-high-availability-architecture-scenarios) 」を参照してください。

#### <a name="azure-availability-sets-vs-availability-zones"></a>Azure の可用性セット対可用性ゾーン

HA インフラストラクチャをデプロイする前に、選択したリージョンに応じて、 [Azure 可用性セット](/azure/virtual-machines/availability) と可用性ゾーンのどちらを使用してデプロイするかを決定します。 可用性セットを使用してデプロイされた仮想マシンの主な違いは次のとおりです。

- 仮想マシンが複数の Availability Zones に分散していない。

- ホストはセットにデプロイされている最初の仮想マシンによって定義されるため、1 つの可用性セットでデプロイできる仮想マシンの種類は制限されます。 1 つの例として、M シリーズと E シリーズの仮想マシンを 1 つの可用性セットに結合することはできません。

さまざまな Availability Zones にわたって高可用性アーキテクチャをデプロイする利点の 1 つは、仮想マシンの SLA が高くなる可能性があることです。 詳細については、「[AZURE 仮想マシンの SLA](https://azure.microsoft.com/support/legal/sla/virtual-machines/v1_9/)」を参照してください。 Azure リージョンによっては、仮想マシン間のネットワーク トラフィックで異なるネットワーク待機時間が検出されることがあります。 さまざまな可用性ゾーンに及ぶ SAP ワークロードのデプロイの詳細については、「[Azure Availability Zones を使用した SAP ワークロードの構成](/azure/virtual-machines/workloads/sap/sap-ha-availability-zones)」に関する情報を参照してください。

**高可用性のための設計上の推奨事項:**

- Azure には、アプリケーションがインフラストラクチャの SLA を満たすために役立ついくつかのオプションが用意されています。 すべての SAP コンポーネント (中央サービス、アプリケーション サーバー、およびデータベース) に対して同じオプションを選択する必要があります。

  - 1 つの VM SLA で、99.9% が提供されます。
  - 可用性セットのデプロイでは、99.95% が提供されます。
  - Availability Zones では、99.99% が提供されます。

- 可用性セットのデプロイでは、SAP システムの各コンポーネントが独自の可用性セットに含まれている必要があります。 SAP 中央サービス、データベース、およびアプリケーション仮想マシンは、可用性セットにグループ化する必要があります。

- 可用性セットのデプロイで Azure 近接配置グループを使用する場合、3 つの SAP コンポーネント (中央サービス、アプリケーションサーバー、データベース) はすべて同じ近接配置グループに存在する必要があります。

- SAP SID ごとに 1 つの近接配置グループを使用します。 グループは、可用性ゾーンまたは Azure リージョンにまたがっていません。

- Azure は現在、同じ Linux Pacemaker クラスターでの ASCS とデータベース HA の組み合わせをサポートしていません。個々のクラスターに分割します。 ただし、最大 5 つの [複数の中央サービス クラスター](/azure/virtual-machines/workloads/sap/high-availability-guide-suse-multi-sid) を 1 組の仮想マシンに結合できます。

- ASCS および DB クラスターの前に Standard Load Balancer の SKU を使用します。

- すべての実稼働システムは、プレミアム管理された SSD 上で実行し、Azure NetApp Files または Ultra ディスクを使用する必要があります。 パフォーマンスを向上させ、SLA を最大限に高めるために少なくとも OS ディスクは Premium レベルである必要があります。

- HA ペア内の両方の仮想マシンを可用性セットにデプロイする必要があります。または、Availability Zones は同じサイズで、同じストレージ構成を使用する必要があります。

- HA ペア内のデータベースを同期するには、ネイティブ データベース レプリケーションのテクノロジを使用する必要があります。

- さまざまなオペレーティングシステムで SAP 中央サービス クラスターを実行するには、次のサービスのいずれかを選択する必要があります。

  - [SUSE Linux Enterprise Server の Pacemaker クラスター](/azure/virtual-machines/workloads/sap/high-availability-guide-suse-netapp-files): 最大 3 つの STONITH ブロック デバイス (SBD) または Azure フェンス エージェントをサポートします。
  - [Red Hat Enterprise Linux の Pacemaker クラスター](/azure/virtual-machines/workloads/sap/high-availability-guide-rhel-netapp-files): SBD はまだサポートされていません。Azure フェンス エージェントのみがサポートされています。
  - [Windows クラスター](/azure/virtual-machines/workloads/sap/sap-ascs-ha-multi-sid-wsfc-shared-disk)
  - SAP 認定のサードパーティ クラスターのソフトウェア

- 中央サービスおよびデータベース クラスターのドキュメントで推奨されるクラスターのタイムアウト パラメーターを設定する必要があります。

### <a name="backuprestore"></a>バックアップ/復元

**バックアップ/復元の設計に関する考慮事項:**

バックアップや復元は通常、運用 SAP ワークロードでは適切な HA 機能とは見なされませんが、このテクノロジは他のさまざまな領域に対応しています。 SAP アプリケーションを使用するほとんどの企業は、長年にわたってバックアップを保存する必要があるコンプライアンス規制に従う必要があります。 バックアップがあり、そこから復元できることが重要な他の条件とシナリオもあります。 SAP アプリケーションをデプロイするためのバックアップと復元のベストプラクティスを既に確立していることを前提としています。 そのため、以下を行うことができます。

- RTO を満たす任意の時点と時間枠で、実稼働データベースの特定の時点への復旧を実行します。特定の時点への復旧には、通常、DBMS レイヤーまたは SAP を介してデータを削除する演算子エラーが含まれます。

- コンプライアンスに関する規制に準拠するために、長期間のバックアップを保持するストアを維持します。

- データベース バックアップを使用して SAP システムを複製し、別のサーバーまたは VM に復元します。

- データベース バックアップからの実稼働データベース データを使用して、実稼働前システムを更新します。

- SAP アプリケーションサーバー、仮想マシン、ディスク、または VM スナップショットをバックアップします。

オンプレミスでこれを行うことができる場合は、これらの機能を Azure の SAP システムに取り込む必要があります。

現在のソリューションに問題がなければ、バックアップ ベンダーが Azure のデプロイをサポートしているかどうか、または Azure でサービスとしてのソフトウェア (SaaS) ソリューションを設定したかどうかを確認してください。

Azure には、VM スナップショットを取得し、ストリーミング[SQL Server](/azure/backup/backup-azure-sql-database)と[SAP HANA](/azure/backup/sap-hana-db-about)バックアップを管理する、 [Azure Backup](/azure/backup/backup-overview) のバックアップ SaaS サービスが用意されています。 [Azure NetApp Files](https://azure.microsoft.com/services/netapp/)を使用して SAP HANA データベースを格納している場合は、HANA 整合ストレージ スナップショットに基づいてバックアップを実行できます。

**バックアップ/復元の設計に関する推奨事項:**

- Azure Backup を使用して、SAP アプリケーションサーバーと中央サービスの仮想マシンをバックアップできます。

- SAP HANA バックアップは、最大 8 TB までの HANA デプロイに使用できます。 詳細については、 [Azure 仮想マシン上の SAP HANA データベースのバックアップ](/azure/backup/sap-hana-backup-support-matrix)に関するサポート マトリックスを参照してください。

- バックアップと回復の時間をテストして、RTO を満たしているかどうかを確認します。

- Azure からオンプレミスのバックアップ インフラストラクチャ (特に大規模なデータベース) にバックアップをプルすることはお勧めしません。 このオプションは、ExpressRoute 回線が使用する帯域幅の量に影響します。

### <a name="dr"></a>DR

**DR の設計に関する考慮事項:**

[Azure リージョン マップ](https://azure.microsoft.com/global-infrastructure/geographies/)には、60 を超える Azure リージョンが表示され、すべてのリージョンが同じサービスを実行するわけではありません。 大規模な SAP ソフトウェアのデプロイ中、特に SAP HANA を使用する場合は、Azure [M シリーズ](/azure/virtual-machines/m-series) または [Mv2 シリーズ](/azure/virtual-machines/mv2-series) の仮想マシンを提供する Azure リージョンを探します。 また Azure Storage は、異なるリージョンをペアにして、ストレージの種類の小さなサブセットを別のリージョンにレプリケートします。 詳細については、「[Azure ペア領域の概要](/azure/best-practices-availability-paired-regions)」を参照してください。

SAP ワークロード用に Azure リージョンを組み合わせることの主な課題は次のとおりです。

- ペアは、M シリーズまたは Mv2 シリーズの VM サービスと常に一致するとは限りません。 SAP システムをデプロイしている多くのお客様は、Azure のペアになっているリージョンではなく、必要な VM ファミリのサービスの可用性に従っています。

- Standard storage はペアのリージョン間でレプリケートできますが、データベースや仮想ハードディスクを格納することはできません。 使用するペアのリージョン間でのみバックアップをレプリケートするように制限されています。 他のすべてのデータについては、SQL Server Always On、SAP HANA システム レプリケーション、およびその他のサービスなどのネイティブ DBMS 機能を使用して、独自のレプリケーションを実行します。 SAP アプリケーション レイヤーには、Azure Site Recovery、`rsync`/`robocopy`、およびその他のサードパーティ製ソフトウェアを組み合わせて使用します。

Azure リージョンを定義した後、運用システムをプライマリ リージョンにデプロイするか、実稼働前の SAP システムを DR リージョンにデプロイするか、またはすべての SAP システムをプライマリ リージョンにグループ化するアーキテクチャを使用して DR リージョンのみが DR リージョンに使用されるかを検討する必要があります。 現在の SAP 顧客のデプロイ パターンでは、ほとんどのお客様が稼働中の SAP システムの両方のリージョンを使用することが示されています。 従来、実稼働システムの完全なコピーをビジネス回帰テスト システムとして実行していたお客様は、通常、SAP 製品ラインのビジネス回帰テスト システムを DR ターゲットとして使用する予定です。

少なくとも 2 つの Azure リージョンのうちどちらが DR リージョンであるかを判断するためのもう 1 つの重要な設計要素は、Azure に接続する Azure ExpressRoute 回線が複数あるかどうかです。 少なくとも 1 つの ExpressRoute 回線がプライマリ Azure リージョンに接続し、もう 1 つは DR リージョンに接続する必要があります。 この種類のアーキテクチャでは、別のリージョンにある Azure ネットワークに接続して、別の Azure リージョンに壊滅的な影響がある場合は接続を保護する必要があります。

一部のお客様は、HA/DR アーキテクチャの組み合わせを使用しています。これは、同じ Azure リージョンで HA と DR をグループ化するもので、一般的には推奨されません。 [Azure Availability Zones](/azure/availability-zones/az-overview) は、このアーキテクチャをサポートしています。 1 つの Azure リージョン内の可用性ゾーン間の距離は、2 つの異なる Azure リージョン間の距離と同じではないため、自然災害によって、このアーキテクチャが発生しているリージョンでこのアーキテクチャが危険にさらされる可能性があります。 次の理由により、お客様はこのアーキテクチャを選択してください。

- 運用環境のデプロイと DR ターゲットの間での距離が少ない構成からの十分な対応
- データ主権の側面
- 地理的要因

DR リージョンを選択する際に考慮する必要があるもう 1 つの要因は、DR サイトにフェールオーバーするための RPO と RTO です。 さらに、実稼働リージョンと DR リージョンの間の距離により、ネットワーク待機時間が長くなります。 異なる Azure リージョン間で非同期的にレプリケートしますが、ネットワーク待機時間が短いか、またはそれよりも大きい場合は、レプリケートできるスループットと RPO ターゲットに影響を与える可能性があります。 多くの場合、HA/DR アーキテクチャを使用して RPO を最小限に抑えることができますが、大規模な自然災害からのリスクが高くなる可能性があります。

**ディザスター リカバリーのための設計上の推奨事項:**

- プライマリ仮想ネットワーク (VNet) の CIDR は、DR サイトの VNet の CIDR と競合したり、重複したりすることはできません。

- オンプレミスからプライマリとセカンダリの Azure DR リージョンへの ExpressRoute 接続を設定します。

- オンプレミスからプライマリとセカンダリの Azure DR リージョンへ、ExpressRoute を使用した代替が VPN 接続に設定されます。

- Site Recovery を使用して、アプリケーション サーバーを DR サイトにレプリケートします。 また Site Recovery は、中央サービス クラスターの仮想マシンを DR サイトにレプリケートする場合にも役立ちます。 DR を呼び出す場合は、DR サイトで Linux Pacemaker クラスターを再構成する必要があります (たとえば、VIP や SBD の置き換え、実行 `corosync.conf` など)。

- Azure NetApp Files でリージョン間レプリケーションを使用して、プライマリ リージョンと DR リージョンの間でファイル ボリュームを同期します。 リージョン間レプリケーションは、[現在パブリック プレビュー段階です](/azure/azure-netapp-files/cross-region-replication-introduction)。

- データを DR サイトに同期するには、ネイティブデータベース レプリケーションを使用する必要があります。Site Recovery は使用しないでください。

- プライマリと DR の VNet をピアリングします。 たとえば、HANA システム レプリケーションの場合、SAP HANA DB VNet を DR サイトの SAP HANA DB VNet とピアリングする必要があります。

- SAP デプロイに Azure NetApp Files ストレージを使用する場合は、少なくとも Premium レベルの 2 つの異なるリージョンに 2 つの Azure NetApp Files アカウントを作成する必要があります。
